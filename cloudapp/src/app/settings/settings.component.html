<!-- Przycisk "Save" jest teraz "wstrzykiwany" do komponentu app-topmenu -->
<app-topmenu>
  <div buttons>
    <button mat-flat-button color="primary" (click)="saveSettings()" [disabled]="form.pristine || saving">
        Save
    </button>
  </div>
</app-topmenu>

<!-- Tytuł strony jest teraz oddzielnie -->
<h2 class="dialog-title-final" style="font-size: 24px; font-weight: bold; margin-top: 1rem;">Settings</h2>


<div class="loading-shade" *ngIf="saving">
  <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
</div>

<!-- Formularz jest używany tylko wtedy, gdy jest zainicjowany -->
<form [formGroup]="form" *ngIf="form">
  <mat-dialog-content class="mat-dialog-content">
    <div class="columns-config">
      
      <p class="instruction-text" style="color: #616161; margin-bottom: 20px;">
        Select the fields you want to export. Click on a field name to change the column name, and drag to reorder.
      </p>

      <!-- Akcje dotyczące listy pól zostały zgrupowane razem -->
      <div class="column-actions" style="margin-bottom: 15px; border-bottom: 1px solid #e0e0e0; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
        <mat-checkbox 
          color="primary"
          [checked]="allFieldsSelected"
          [indeterminate]="someFieldsSelected"
          (change)="toggleSelectAll($event)">
          Check/Uncheck All ({{ selectedFieldsCount }}/{{ fieldsFormArray.length }})
        </mat-checkbox>
        
        <!-- Przycisk resetowania jest teraz tutaj -->
        <button mat-stroked-button color="warn" (click)="resetSettings()">
          Reset to Defaults
        </button>
      </div>
      
      <!-- Kontener Drag and Drop -->
      <div formArrayName="availableFields" cdkDropList (cdkDropListDropped)="drop($event)">
        
        <!-- Pętla po wszystkich dostępnych polach -->
        <div *ngFor="let fieldControl of fieldsFormArray.controls; let i = index" [formGroupName]="i" cdkDrag
             class="field-row-container mat-elevation-z1"
             (mouseenter)="hoverIndex = i" 
             (mouseleave)="hoverIndex = null"
             [class.expanded]="expandedIndex === i">
          
          <div class="field-item">
            
            <!-- 1. Uchwyt Drag and Drop -->
            <mat-icon cdkDragHandle 
                      [style.visibility]="hoverIndex === i ? 'visible' : 'hidden'" 
                      class="drag-handle-icon">drag_indicator</mat-icon>
            
            <!-- 2. Checkbox wyboru pola -->
            <div class="field-checkbox-cell">
              <mat-checkbox formControlName="selected"></mat-checkbox>
            </div>

            <!-- 3. Etykieta pola (rozwija sekcję) -->
            <div class="field-label-cell" (click)="toggleExpand(i)">
              {{ fieldControl.value.label }}
              <mat-icon class="expand-arrow" [class.expanded]="expandedIndex === i">keyboard_arrow_down</mat-icon>
            </div>
            
          </div>

          <!-- Rozwijana sekcja do edycji nazwy kolumny -->
          <div class="expanded-section" *ngIf="expandedIndex === i">
            <mat-form-field appearance="outline" class="custom-label-input">
              <!-- <mat-label>Override column name</mat-label> -->
              <input matInput formControlName="customLabel" [placeholder]="fieldControl.value.label">
            </mat-form-field>
            <!-- <p class="api-name-info">API field name: **{{ fieldControl.value.name }}**</p> -->
          </div>
          
        </div>
      </div>
    </div>
  </mat-dialog-content>
</form>

