<!-- Przycisk "Save" jest teraz "wstrzykiwany" do komponentu app-topmenu -->
<app-topmenu>
  <div buttons>
    <button mat-flat-button color="primary" (click)="saveSettings()" [disabled]="form.pristine || saving">
        Save
    </button>
  </div>
</app-topmenu>

<div class="loading-shade" *ngIf="saving">
  <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
</div>

<!-- Formularz jest używany tylko wtedy, gdy jest zainicjowany -->
<form [formGroup]="form" *ngIf="form" class="settings-form">
    <h2 class="dialog-title-final" style="font-size: 18px; font-weight: bold;">Settings</h2>

    <p class="instruction-text" style="color: #616161; margin-bottom: 20px;">
        Select the fields you want to export. Click on a field name to change the column name, and drag to reorder. In the text field below, you can customize the file header.
    </p>

    <!-- NOWE POLE: Niestandardowy nagłówek pliku -->
    <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 20px;">
        <mat-label>Custom File Header</mat-label>
        <textarea matInput formControlName="customHeader" rows="3" placeholder="Enter the text that will appear at the top of the exported file."></textarea>
    </mat-form-field>
    
    <mat-dialog-content class="mat-dialog-content">
        <div class="columns-config">
            
            <!-- ZMIENIONO STYL I TREŚĆ PRZYCISKU -->
            <div class="column-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <mat-checkbox 
                    [checked]="allFieldsSelected"
                    [indeterminate]="someFieldsSelected"
                    (change)="toggleSelectAll($event)">
                    Check/Uncheck All ({{ selectedFieldsCount }}/{{ fieldsFormArray.length }})
                </mat-checkbox>
                <button mat-stroked-button color="warn" (click)="resetSettings()">
                    Reset Settings <!-- ZMIENIONO NAZWĘ -->
                </button>
            </div>
            
            <!-- Kontener Drag and Drop -->
            <div formArrayName="availableFields" cdkDropList (cdkDropListDropped)="drop($event)">
                
                <!-- Pętla po wszystkich dostępnych polach -->
                <div *ngFor="let fieldControl of fieldsFormArray.controls; let i = index" [formGroupName]="i" cdkDrag
                     class="field-row-container mat-elevation-z1"
                     (mouseenter)="hoverIndex = i" 
                     (mouseleave)="hoverIndex = null"
                     [class.expanded]="expandedIndex === i">
                    
                    <div class="field-item">
                        <mat-icon cdkDragHandle [style.visibility]="hoverIndex === i ? 'visible' : 'hidden'" class="drag-handle-icon">drag_indicator</mat-icon>
                        <div class="field-checkbox-cell">
                            <mat-checkbox formControlName="selected"></mat-checkbox>
                        </div>
                        <div class="field-label-cell" (click)="toggleExpand(i)" style="font-size: 14px;">
                            {{ fieldControl.value.label }}
                            <mat-icon class="expand-arrow" [class.expanded]="expandedIndex === i">keyboard_arrow_down</mat-icon>
                        </div>
                    </div>

                    <div class="expanded-section" *ngIf="expandedIndex === i">
                        <mat-form-field appearance="outline" class="custom-label-input">
                            <mat-label>Customize Column Name</mat-label>
                            <input matInput formControlName="customLabel" [placeholder]="fieldControl.value.label">
                        </mat-form-field>
                    </div>
                </div>
            </div>
        </div>
    </mat-dialog-content>
</form>

