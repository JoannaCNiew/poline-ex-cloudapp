<div class="dialog-header-actions">
  <button mat-flat-button color="default" (click)="onCancel()">
    <mat-icon>arrow_back</mat-icon> Back
  </button>
</div>

<h2 class="dialog-title-final" style="font-size: 18px; font-weight: bold;">Settings</h2>

<!-- Górny pasek akcji -->
<div class="top-dialog-actions" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
  <!-- Przycisk resetowania po lewej stronie -->
  <button mat-stroked-button color="warn" (click)="resetSettings()">
    Reset Settings
  </button>
  
  <!-- Przyciski Anuluj i Zapisz po prawej stronie -->
  <div>
    <button mat-flat-button color="default" (click)="onCancel()">Cancel</button>
    <button mat-flat-button color="primary" (click)="saveSettings()" [disabled]="form.pristine || saving" style="margin-left: 8px;">Save</button>
  </div>
</div>

<div class="loading-shade" *ngIf="saving">
  <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
</div>

<!-- Formularz jest używany tylko wtedy, gdy jest zainicjowany -->
<form [formGroup]="form" *ngIf="form">
  <mat-dialog-content class="mat-dialog-content">
    <div class="columns-config">
      
      <p class="instruction-text" style="color: #616161; margin-bottom: 20px;">
        Select the fields you want to export. Click on a field name to change the column name, and drag to reorder.
      </p>

      <!-- ZMIENIONA SEKCJA: Ujednolicony checkbox "Zaznacz/Odznacz wszystko" -->
      <div class="column-actions" style="margin-bottom: 15px; border-bottom: 1px solid #e0e0e0; padding-bottom: 15px;">
        <mat-checkbox 
          color="primary"
          [checked]="allFieldsSelected"
          [indeterminate]="someFieldsSelected"
          (change)="toggleSelectAll($event)">
          Check/Uncheck All ({{ selectedFieldsCount }}/{{ fieldsFormArray.length }})
        </mat-checkbox>
      </div>
      
      <!-- Kontener Drag and Drop -->
      <div formArrayName="availableFields" cdkDropList (cdkDropListDropped)="drop($event)">
        
        <!-- Pętla po wszystkich dostępnych polach -->
        <div *ngFor="let fieldControl of fieldsFormArray.controls; let i = index" [formGroupName]="i" cdkDrag
             class="field-row-container mat-elevation-z1"
             (mouseenter)="hoverIndex = i" 
             (mouseleave)="hoverIndex = null"
             [class.expanded]="expandedIndex === i">
          
          <div class="field-item">
            
            <!-- 1. Uchwyt Drag and Drop -->
            <mat-icon cdkDragHandle 
                      [style.visibility]="hoverIndex === i ? 'visible' : 'hidden'" 
                      class="drag-handle-icon">drag_indicator</mat-icon>
            
            <!-- 2. Checkbox wyboru pola -->
            <div class="field-checkbox-cell">
              <mat-checkbox formControlName="selected"></mat-checkbox>
            </div>

            <!-- 3. Etykieta pola (rozwija sekcję) -->
            <div class="field-label-cell" (click)="toggleExpand(i)" style="font-size: 14px;">
              {{ fieldControl.value.label }}
              <mat-icon class="expand-arrow" [class.expanded]="expandedIndex === i">keyboard_arrow_down</mat-icon>
            </div>
            
          </div>

          <!-- Rozwijana sekcja do edycji nazwy kolumny -->
          <div class="expanded-section" *ngIf="expandedIndex === i">
            <mat-form-field appearance="outline" class="custom-label-input">
              <!-- <mat-label>Override column name</mat-label> -->
              <input matInput formControlName="customLabel" [placeholder]="fieldControl.value.label">
            </mat-form-field>
            <!-- <p class="api-name-info">API field name: **{{ fieldControl.value.name }}**</p> -->
          </div>
          
        </div>
      </div>
    </div>
  </mat-dialog-content>
</form>

