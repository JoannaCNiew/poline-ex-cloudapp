<div class="header-actions" style="display: flex; justify-content: flex-end; padding: 10px;">

    <button mat-button color="secondary" [routerLink]="['/']" style="margin-right: 15px;">
        <mat-icon>arrow_back</mat-icon>
        <span>{{ 'TopMenu.Home' | translate }}</span> 
    </button>

    <button mat-flat-button color="primary" (click)="saveSettings()" [disabled]="form.pristine || saving">
        <span>{{ 'Settings.Buttons.Save' | translate }}</span>
    </button>
</div>

<div class="loading-shade" *ngIf="saving">
    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
</div>

<form [formGroup]="form" *ngIf="form" class="settings-form">
    <h2 class="dialog-title-final" style="font-size: 18px; font-weight: bold;" translate>Settings.Title</h2>

    <p class="instruction-text" style="color: #616161; margin-bottom: 20px;" translate>
        Settings.Instruction
    </p>

    <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 20px;">
        <mat-label translate>Settings.CustomHeader.Label</mat-label>
        <textarea matInput formControlName="customHeader" rows="3" [placeholder]="'Settings.CustomHeader.Placeholder' | translate"></textarea>
    </mat-form-field>
    
    <mat-dialog-content class="mat-dialog-content">
        <div class="columns-config">
            
            <div class="column-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <mat-checkbox 
                    [checked]="allFieldsSelected"
                    [indeterminate]="someFieldsSelected"
                    (change)="toggleSelectAll($event)">
                    <span translate>Settings.Fields.ToggleAll</span> ({{ selectedFieldsCount }}/{{ fieldsFormArray.length }})
                </mat-checkbox>
                <button mat-stroked-button color="warn" (click)="resetSettings()">
                    <span>{{ 'Settings.Buttons.Reset' | translate }}</span>
                </button>
            </div>
            
            <div formArrayName="availableFields" cdkDropList (cdkDropListDropped)="drop($event)">
                
                <div *ngFor="let fieldControl of fieldsFormArray.controls; let i = index" [formGroupName]="i" cdkDrag
                     class="field-row-container mat-elevation-z1"
                     (mouseenter)="hoverIndex = i" 
                     (mouseleave)="hoverIndex = null"
                     [class.expanded]="expandedIndex === i">
                    
                    <div class="field-item">
                        <mat-icon cdkDragHandle [style.visibility]="hoverIndex === i ? 'visible' : 'hidden'" class="drag-handle-icon">drag_indicator</mat-icon>
                        <div class="field-checkbox-cell">
                            <mat-checkbox formControlName="selected"></mat-checkbox>
                        </div>
                        <div class="field-label-cell" (click)="toggleExpand(i)" style="font-size: 14px;">
                            {{ fieldControl.value.label | translate }}
                            <mat-icon class="expand-arrow" [class.expanded]="expandedIndex === i">keyboard_arrow_down</mat-icon>
                        </div>
                    </div>

                    <div class="expanded-section" *ngIf="expandedIndex === i" style="padding-left: 40px;">
                        <mat-form-field appearance="outline" class="custom-label-input">
                            <mat-label translate>Settings.Fields.CustomizeLabel</mat-label>
                            <input matInput formControlName="customLabel" [placeholder]="fieldControl.value.label | translate">
                        </mat-form-field>
                    </div>
                </div>
            </div>
        </div>
    </mat-dialog-content>
</form>