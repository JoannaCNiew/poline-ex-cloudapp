<app-topmenu></app-topmenu>

<div *ngIf="entities$ | async as entities">
    <!-- Przekazujemy wszystkie encje do zmiennej widocznej w komponencie -->
    <ng-container *ngIf="visibleEntities.length > 0; then entitylist; else noentities"></ng-container>

    <!-- Szablon dla braku encji (niezmieniony) -->
    <ng-template #noentities>
        <div class="cloudapp-body">
            <h1>Witaj w CloudApp do Eksportu PO Line</h1>
            <p>Aby rozpocząć, przejdź do listy zamówień (PO Line List) w Almie. Ta aplikacja automatycznie wyświetli widoczne tam pozycje, które możesz zaznaczyć i wyeksportować.</p>
        </div>
    </ng-template>

    <!-- NOWY SZABLON DLA LISTY ENCJ Z CHECKBOXAMI -->
    <ng-template #entitylist>
        <div class="cloudapp-body">
            <!-- Pierwsza karta: Wybór encji -->
            <mat-card>
                <mat-card-header>
                    <mat-card-title>
                        Wybór linii zamówienia ({{ selectedEntities.length }}/{{ visibleEntities.length }})
                    </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <!-- Przycisk Clear/Reset -->
                    <div class="eca-actions" style="margin-bottom: 15px;">
                        <button mat-flat-button color="secondary" (click)="clear()" [disabled]="selectedEntities.length === 0">Wyczyść wybór</button>
                    </div>

                    <!-- Zaznacz/Odznacz wszystko -->
                    <mat-checkbox 
                        [checked]="isAllSelected(visibleEntities)"
                        [indeterminate]="selectedEntities.length > 0 && !isAllSelected(visibleEntities)"
                        (change)="masterToggle(visibleEntities)">
                        Zaznacz/Odznacz wszystko
                    </mat-checkbox>
                    
                    <mat-divider style="margin-top: 5px;"></mat-divider>
                    
                    <!-- Lista encji do wyboru -->
                    <mat-list>
                        <mat-list-item *ngFor="let entity of visibleEntities">
                            <mat-checkbox [checked]="isSelected(entity)" (change)="toggleEntity(entity)">
                                {{ entity.description }}
                            </mat-checkbox>
                        </mat-list-item>
                    </mat-list>
                </mat-card-content>
            </mat-card>
            
            <!-- Druga karta: Przycisk generowania (pojawia się po wybraniu) -->
            <mat-card *ngIf="selectedEntities.length > 0">
                <mat-card-content>
                    <p>Wybrano <strong>{{ selectedEntities.length }}</strong> linii zamówienia do przetworzenia.</p>
                    <button mat-raised-button color="primary" (click)="generatePreview()" [disabled]="loading">
                        <mat-icon>cloud_download</mat-icon> Generuj podgląd eksportu
                    </button>
                </mat-card-content>
            </mat-card>

            <!-- Trzecia karta: Podgląd i eksport -->
            <mat-card *ngIf="previewContent">
                <mat-card-header>
                    <mat-card-title>Podgląd Pliku TXT</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <mat-form-field appearance="outline" style="width: 100%;">
                        <mat-label>Zawartość pliku TXT (ISBN i Quantity)</mat-label>
                        <textarea matInput rows="10" [value]="previewContent" readonly #exportContent></textarea>
                    </mat-form-field>

                    <div class="export-actions">
                        <button mat-raised-button color="accent" (click)="copyToClipboard(exportContent)">
                            <mat-icon>content_copy</mat-icon> Kopiuj do schowka
                        </button>
                        <button mat-raised-button color="primary" (click)="downloadFile()">
                            <mat-icon>save_alt</mat-icon> Pobierz plik TXT
                        </button>
                    </div>
                </mat-card-content>
            </mat-card>

        </div>
    </ng-template>

</div>

<div class="loading-shade" *ngIf="loading">
  <mat-spinner diameter="50"></mat-spinner>
</div>
